#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <irq.h>
#include <uart.h>
#include <console.h>
#include <generated/csr.h>

void wait_ms(unsigned int time);

void wait_ms(unsigned int time){
	timer0_en_write(0);
	timer0_reload_write(0);
	timer0_load_write(time*(CONFIG_CLOCK_FREQUENCY/1000));
	timer0_en_write(1);
	timer0_update_value_write(1);
	while(timer0_value_read()) timer0_update_value_write(1);
}

int main(void) {

  irq_setmask((1<<UART_INTERRUPT));
  irq_setie(1);
  uart_init();


  static const int16_t image[784]={-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,55,127,127,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,-6,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,14,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,35,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,14,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,35,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,35,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,127,127,127,127,127,127,127,127,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6};
  char str[3];

  AccQuant_cnn_EN_write(0);
  AccQuant_cnn_RST_write(0);
  printf("MAX_OK = %d \n",AccQuant_cnn_MAX_OK_read());
  
  AccQuant_cnn_WEN_IMAGE_write(0);
  //AccQuant_cnn_WADD_IMAGE_write(0);
  //AccQuant_cnn_WDATA_IMAGE_write(0);

  printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());


  printf("Llenar Memoria \n");
  printf("**********************\n");
  printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());

  AccQuant_cnn_WEN_IMAGE_write(1);
  for(int i = 0; i < 784; i++)
  {
    printf("image[i] = %i \n",image[i]);
    sprintf(str, "image[%d] = %d",i, image[i]);
    puts(str);
    printf("\n");
    AccQuant_cnn_WADD_IMAGE_write(i);
    AccQuant_cnn_WDATA_IMAGE_write(image[i]);
    printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());
    wait_ms(50);
  };
  printf("Memoria Lllena\n");
  printf("**********************\n");
  printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());
  printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());
  printf("Activa Acelerador\n");
  printf("**********************\n");







  printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());
  printf("MEM_OK = %d \n",AccQuant_cnn_MEM_OK_read());





  

  printf("MAX_OK = %d \n",AccQuant_cnn_MAX_OK_read());

  AccQuant_cnn_RST_write(1);
  //AccQuant_cnn_EN_write(1);
  printf("MAX_OK = %d \n",AccQuant_cnn_MAX_OK_read());
  AccQuant_cnn_RST_write(0);
  AccQuant_cnn_EN_write(1);
  printf("MAX_OK = %d \n",AccQuant_cnn_MAX_OK_read());
  wait_ms(50);
  AccQuant_cnn_EN_write(0);
  printf("MAX_OK = %d \n",AccQuant_cnn_MAX_OK_read());

/*
  while(!AccQuant_cnn_MAX_OK_read())
  {
      AccQuant_cnn_RST_write(1);
      printf("Estoy en un while!\n");
      printf("**********************\n");
      wait_ms(50);
      AccQuant_cnn_RST_write(0);
  }
*/













   
   

   return 0;
}